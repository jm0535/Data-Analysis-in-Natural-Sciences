---
prefer-html: true
---

# Common Statistical Tests

## Introduction

This chapter explores common statistical tests used in natural sciences research. Building on the hypothesis testing framework introduced in the previous chapter, we'll examine specific tests for different research scenarios and data types.

## Choosing the Right Statistical Test

Selecting the appropriate statistical test depends on several factors:

1. **Research Question**: What you're trying to determine
2. **Data Type**: Categorical, continuous, or ordinal
3. **Number of Groups**: One, two, or multiple groups
4. **Data Distribution**: Normal or non-normal
5. **Independence**: Whether observations are independent or related

### Decision Tree for Common Tests

```{r}
#| echo: false
#| fig-cap: "Decision tree for selecting appropriate statistical tests"
#| eval: false

# This code requires the DiagrammeR package
# If you want to run this code, first install the package with:
# install.packages("DiagrammeR")

library(DiagrammeR)

grViz("
digraph test_selection {
  # Node definitions
  node [shape = rectangle, fontname = 'Arial', fontsize = 10, style = filled, fillcolor = lightblue]
  
  start [label = 'Research Question', fillcolor = lightgreen]
  
  # First level: Number of variables
  one_var [label = 'One Variable']
  two_var [label = 'Two Variables']
  multi_var [label = 'Multiple Variables']
  
  # Second level for one variable
  one_sample [label = 'One Sample']
  two_sample [label = 'Two Samples']
  multi_sample [label = 'Multiple Samples']
  
  # Tests for one variable
  t_test [label = 'One-Sample t-Test\\n(Normal, Continuous)']
  wilcox [label = 'Wilcoxon Signed-Rank\\n(Non-normal, Continuous)']
  binom [label = 'Binomial Test\\n(Categorical)']
  
  # Tests for two variables - two samples
  ind_t [label = 'Independent t-Test\\n(Normal, Continuous)']
  paired_t [label = 'Paired t-Test\\n(Normal, Continuous, Related)']
  mann [label = 'Mann-Whitney U\\n(Non-normal, Continuous)']
  wilcox_paired [label = 'Wilcoxon Signed-Rank\\n(Non-normal, Continuous, Related)']
  chi_sq [label = 'Chi-Square Test\\n(Categorical)']
  mcnemar [label = 'McNemar Test\\n(Categorical, Related)']
  
  # Tests for multiple samples
  anova [label = 'ANOVA\\n(Normal, Continuous)']
  rm_anova [label = 'Repeated Measures ANOVA\\n(Normal, Continuous, Related)']
  kruskal [label = 'Kruskal-Wallis\\n(Non-normal, Continuous)']
  friedman [label = 'Friedman Test\\n(Non-normal, Continuous, Related)']
  chi_sq_multi [label = 'Chi-Square Test\\n(Categorical)']
  
  # Tests for relationships
  pearson [label = 'Pearson Correlation\\n(Normal, Continuous)']
  spearman [label = 'Spearman Correlation\\n(Non-normal or Ordinal)']
  linear_reg [label = 'Linear Regression\\n(Continuous Predictor & Outcome)']
  logistic [label = 'Logistic Regression\\n(Continuous Predictor, Binary Outcome)']
  
  # Multiple variables
  manova [label = 'MANOVA\\n(Multiple Continuous Outcomes)']
  pca [label = 'Principal Component Analysis\\n(Dimension Reduction)']
  cluster [label = 'Cluster Analysis\\n(Grouping)']
  
  # Connections
  start -> {one_var two_var multi_var}
  
  one_var -> {one_sample two_sample multi_sample}
  
  one_sample -> {t_test wilcox binom}
  
  two_sample -> {ind_t paired_t mann wilcox_paired chi_sq mcnemar}
  
  multi_sample -> {anova rm_anova kruskal friedman chi_sq_multi}
  
  two_var -> {pearson spearman linear_reg logistic}
  
  multi_var -> {manova pca cluster}
}
")
```

**Decision Tree for Selecting Statistical Tests:**

1. **For One Variable:**
   - **One Sample:**
     - Normal, Continuous → One-Sample t-Test
     - Non-normal, Continuous → Wilcoxon Signed-Rank Test
     - Categorical → Binomial Test
   
   - **Two Samples:**
     - Normal, Continuous, Independent → Independent t-Test
     - Normal, Continuous, Related → Paired t-Test
     - Non-normal, Continuous, Independent → Mann-Whitney U Test
     - Non-normal, Continuous, Related → Wilcoxon Signed-Rank Test
     - Categorical, Independent → Chi-Square Test
     - Categorical, Related → McNemar Test
   
   - **Multiple Samples:**
     - Normal, Continuous, Independent → ANOVA
     - Normal, Continuous, Related → Repeated Measures ANOVA
     - Non-normal, Continuous, Independent → Kruskal-Wallis Test
     - Non-normal, Continuous, Related → Friedman Test
     - Categorical → Chi-Square Test

2. **For Two Variables:**
   - Normal, Continuous → Pearson Correlation
   - Non-normal or Ordinal → Spearman Correlation
   - Continuous Predictor & Outcome → Linear Regression
   - Continuous Predictor, Binary Outcome → Logistic Regression

3. **For Multiple Variables:**
   - Multiple Continuous Outcomes → MANOVA
   - Dimension Reduction → Principal Component Analysis
   - Grouping → Cluster Analysis

## Parametric vs. Non-Parametric Tests

### Parametric Tests

Parametric tests make assumptions about the underlying population distribution, typically that the data follows a normal distribution. Common parametric tests include:

- t-tests
- ANOVA
- Pearson correlation
- Linear regression

### Non-Parametric Tests

Non-parametric tests make fewer assumptions about the population distribution and are useful when data doesn't meet the assumptions of parametric tests. Common non-parametric tests include:

- Mann-Whitney U test
- Wilcoxon signed-rank test
- Kruskal-Wallis test
- Spearman correlation

### Checking Assumptions

Before applying a parametric test, it's essential to check if your data meets the necessary assumptions. Let's use our crop yield dataset to demonstrate:

```{r}
# Load necessary libraries
library(tidyverse)

# Load the crop yield dataset
crop_yields <- read_csv("../data/agriculture/crop_yields.csv")

# View column names to see how R has formatted them
names(crop_yields)

# Extract wheat yields for analysis
wheat_yields <- crop_yields %>%
  filter(!is.na(`Wheat (tonnes per hectare)`)) %>%
  select(Entity, Year, `Wheat (tonnes per hectare)`)

# View the first few rows
head(wheat_yields)

# Check for normality
# Visual methods
par(mfrow = c(1, 2))
hist(wheat_yields$`Wheat (tonnes per hectare)`, main = "Histogram of Wheat Yields", xlab = "Yield (tonnes/hectare)")
qqnorm(wheat_yields$`Wheat (tonnes per hectare)`); qqline(wheat_yields$`Wheat (tonnes per hectare)`, col = "red")

# Statistical test for normality
shapiro.test(sample(wheat_yields$`Wheat (tonnes per hectare)`, min(5000, length(wheat_yields$`Wheat (tonnes per hectare)`))))
```

## Tests for Comparing Groups

### t-Tests

#### Independent Samples t-Test

Used to compare means between two independent groups. Let's compare wheat yields between two time periods:

```{r}
# Create two groups: early period (before 2000) and recent period (2000 onwards)
crop_yields_grouped <- crop_yields %>%
  filter(!is.na(`Wheat (tonnes per hectare)`) & Year >= 1960) %>%
  mutate(period = ifelse(Year < 2000, "Early Period (pre-2000)", "Recent Period (2000+)"))

# Visualize the data
ggplot(crop_yields_grouped, aes(x = period, y = `Wheat (tonnes per hectare)`, fill = period)) +
  geom_boxplot() +
  labs(title = "Wheat Yields by Time Period",
       x = "Period",
       y = "Wheat Yield (tonnes/hectare)") +
  theme_minimal() +
  theme(legend.position = "none")

# Perform independent samples t-test using formula interface with backticks
t_test_result <- t.test(`Wheat (tonnes per hectare)` ~ period, data = crop_yields_grouped)
t_test_result
```

#### Paired Samples t-Test

Used to compare means between two related groups. Let's compare wheat and rice yields for the same countries and years:

```{r}
# Prepare data for paired t-test
paired_data <- crop_yields %>%
  filter(!is.na(`Wheat (tonnes per hectare)`) & !is.na(`Rice (tonnes per hectare)`)) %>%
  select(Entity, Year, `Wheat (tonnes per hectare)`, `Rice (tonnes per hectare)`)

# View the first few rows
head(paired_data)

# Visualize the paired data
paired_data_long <- paired_data %>%
  pivot_longer(cols = c(`Wheat (tonnes per hectare)`, `Rice (tonnes per hectare)`), names_to = "Crop", values_to = "Yield")

ggplot(paired_data_long, aes(x = Crop, y = Yield, fill = Crop)) +
  geom_boxplot() +
  labs(title = "Comparison of Wheat and Rice Yields",
       x = "Crop Type",
       y = "Yield (tonnes/hectare)") +
  theme_minimal()

# Perform paired t-test using vectors directly
paired_t_test <- t.test(
  paired_data$`Wheat (tonnes per hectare)`, 
  paired_data$`Rice (tonnes per hectare)`, 
  paired = TRUE
)
paired_t_test
```

### Analysis of Variance (ANOVA)

ANOVA is used to compare means among three or more independent groups. Let's compare crop yields across different continents:

```{r}
# Create a mapping of countries to continents (simplified for demonstration)
continent_mapping <- tibble(
  Entity = c("United States", "Canada", "Mexico", 
             "China", "India", "Japan", 
             "Germany", "France", "United Kingdom", 
             "Brazil", "Argentina", "Chile",
             "Egypt", "Nigeria", "South Africa",
             "Australia", "New Zealand"),
  Continent = c(rep("North America", 3), 
                rep("Asia", 3), 
                rep("Europe", 3), 
                rep("South America", 3),
                rep("Africa", 3),
                rep("Oceania", 2))
)

# Join with crop yields data
continental_yields <- crop_yields %>%
  inner_join(continent_mapping, by = "Entity") %>%
  filter(!is.na(`Wheat (tonnes per hectare)`) & Year >= 2000)

# Visualize wheat yields by continent
ggplot(continental_yields, aes(x = Continent, y = `Wheat (tonnes per hectare)`, fill = Continent)) +
  geom_boxplot() +
  labs(title = "Wheat Yields by Continent (2000-present)",
       x = "Continent",
       y = "Wheat Yield (tonnes/hectare)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Perform ANOVA
anova_result <- aov(`Wheat (tonnes per hectare)` ~ Continent, data = continental_yields)
summary(anova_result)

# Post-hoc test to identify which groups differ
TukeyHSD(anova_result)
```

### Non-Parametric Alternatives

#### Mann-Whitney U Test

The Mann-Whitney U test (also called Wilcoxon rank-sum test) is a non-parametric alternative to the independent samples t-test:

```{r}
# Using the same time period groups as before
wilcox_test <- wilcox.test(`Wheat (tonnes per hectare)` ~ period, data = crop_yields_grouped)
wilcox_test
```

#### Kruskal-Wallis Test

The Kruskal-Wallis test is a non-parametric alternative to ANOVA:

```{r}
# Using the same continental data as before
kruskal_result <- kruskal.test(`Wheat (tonnes per hectare)` ~ Continent, data = continental_yields)
kruskal_result

# Post-hoc test for Kruskal-Wallis
if(requireNamespace("dunn.test", quietly = TRUE)) {
  library(dunn.test)
  dunn.test(continental_yields$`Wheat (tonnes per hectare)`, continental_yields$Continent, method = "bonferroni")
} else {
  # Alternative: pairwise Wilcoxon tests
  pairwise.wilcox.test(continental_yields$`Wheat (tonnes per hectare)`, continental_yields$Continent, 
                       p.adjust.method = "bonferroni")
}
```

## Tests for Relationships

### Correlation Analysis

#### Pearson Correlation

Pearson correlation measures the linear relationship between two continuous variables:

```{r}
# Examine correlation between wheat and maize yields
crop_correlation <- crop_yields %>%
  filter(!is.na(`Wheat (tonnes per hectare)`) & !is.na(`Maize (tonnes per hectare)`)) %>%
  select(Entity, Year, `Wheat (tonnes per hectare)`, `Maize (tonnes per hectare)`)

# Visualize the relationship
ggplot(crop_correlation, aes(x = `Wheat (tonnes per hectare)`, y = `Maize (tonnes per hectare)`)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(title = "Relationship Between Wheat and Maize Yields",
       x = "Wheat Yield (tonnes per hectare)",
       y = "Maize Yield (tonnes per hectare)") +
  theme_minimal()

# Calculate Pearson correlation
cor_result <- cor.test(crop_correlation$`Wheat (tonnes per hectare)`, crop_correlation$`Maize (tonnes per hectare)`, method = "pearson")
cor_result
```

#### Spearman Correlation

Spearman correlation is a non-parametric measure of rank correlation:

```{r}
# Calculate Spearman correlation
spearman_result <- cor.test(crop_correlation$`Wheat (tonnes per hectare)`, crop_correlation$`Maize (tonnes per hectare)`, method = "spearman")
spearman_result
```

### Regression Analysis

#### Linear Regression

Linear regression models the relationship between a dependent variable and one or more independent variables:

```{r}
# Create a dataset with year as predictor for wheat yields
time_series_data <- crop_yields %>%
  filter(Entity == "United States" & !is.na(`Wheat (tonnes per hectare)`)) %>%
  arrange(Year)

# Visualize the trend
ggplot(time_series_data, aes(x = Year, y = `Wheat (tonnes per hectare)`)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(title = "Wheat Yield Trends in the United States",
       x = "Year",
       y = "Wheat Yield (tonnes/hectare)") +
  theme_minimal()

# Perform linear regression
lm_model <- lm(`Wheat (tonnes per hectare)` ~ Year, data = time_series_data)
summary(lm_model)

# Check assumptions
par(mfrow = c(2, 2))
plot(lm_model)
```

#### Multiple Regression

Multiple regression includes more than one predictor variable:

```{r}
# Create a dataset with multiple predictors
multi_crop_data <- crop_yields %>%
  filter(!is.na(`Wheat (tonnes per hectare)`) & !is.na(`Rice (tonnes per hectare)`) & !is.na(`Maize (tonnes per hectare)`)) %>%
  select(Entity, Year, `Wheat (tonnes per hectare)`, `Rice (tonnes per hectare)`, `Maize (tonnes per hectare)`)

# Perform multiple regression
multi_model <- lm(`Wheat (tonnes per hectare)` ~ `Rice (tonnes per hectare)` + `Maize (tonnes per hectare)` + Year, data = multi_crop_data)
summary(multi_model)
```

## Tests for Categorical Data

### Chi-Square Test

The Chi-Square test examines the association between categorical variables. Let's use our biodiversity dataset:

```{r}
# Load the biodiversity dataset
plants <- read_csv("../data/ecology/biodiversity.csv")

# Create a contingency table of red list categories by plant group
if("red_list_category" %in% colnames(plants) & "group" %in% colnames(plants)) {
  # Create a contingency table
  contingency_table <- table(plants$red_list_category, plants$group)
  
  # View the table
  contingency_table
  
  # Perform Chi-Square test
  chi_sq_result <- chisq.test(contingency_table)
  chi_sq_result
  
  # Examine residuals to understand the pattern of association
  chi_sq_result$residuals
} else {
  # If the expected columns don't exist, create a demonstration with available data
  message("Required columns not found. Creating a demonstration with available columns.")
  
  # Identify categorical columns
  categorical_cols <- sapply(plants, function(x) is.character(x) || is.factor(x))
  cat_col_names <- names(plants)[categorical_cols]
  
  if(length(cat_col_names) >= 2) {
    # Select the first two categorical columns
    col1 <- cat_col_names[1]
    col2 <- cat_col_names[2]
    
    # Create a contingency table
    contingency_table <- table(plants[[col1]], plants[[col2]])
    
    # View the table
    print(paste("Contingency table of", col1, "by", col2))
    print(contingency_table)
    
    # Perform Chi-Square test if appropriate
    if(min(dim(contingency_table)) > 1 && sum(contingency_table) > 0) {
      chi_sq_result <- chisq.test(contingency_table, simulate.p.value = TRUE)
      print(chi_sq_result)
    } else {
      message("Contingency table not suitable for Chi-Square test.")
    }
  } else {
    message("Not enough categorical columns found for Chi-Square test demonstration.")
  }
}
```

## Tests for Trends and Time Series

### Time Series Analysis

Time series analysis examines data collected over time to identify patterns, trends, and seasonal effects:

```{r}
# Create a time series of wheat yields for a specific country
us_wheat <- crop_yields %>%
  filter(Entity == "United States" & !is.na(`Wheat (tonnes per hectare)`)) %>%
  arrange(Year)

# Convert to time series object
if(requireNamespace("zoo", quietly = TRUE)) {
  library(zoo)
  wheat_ts <- zoo(us_wheat$`Wheat (tonnes per hectare)`, us_wheat$Year)
  
  # Plot the time series
  plot(wheat_ts, main = "US Wheat Yields Over Time",
       xlab = "Year", ylab = "Wheat Yield (tonnes/hectare)")
  
  # Add trend line
  lines(lowess(us_wheat$Year, us_wheat$`Wheat (tonnes per hectare)`), col = "red", lwd = 2)
} else {
  # Basic plot if zoo package is not available
  plot(us_wheat$Year, us_wheat$`Wheat (tonnes per hectare)`, type = "l",
       main = "US Wheat Yields Over Time",
       xlab = "Year", ylab = "Wheat Yield (tonnes per hectare)")
  
  # Add trend line
  lines(lowess(us_wheat$Year, us_wheat$`Wheat (tonnes per hectare)`), col = "red", lwd = 2)
}
```

### Mann-Kendall Trend Test

The Mann-Kendall test is a non-parametric test for identifying trends in time series data:

```{r}
# Perform Mann-Kendall trend test
if(requireNamespace("Kendall", quietly = TRUE)) {
  library(Kendall)
  mk_test <- Kendall::MannKendall(us_wheat$`Wheat (tonnes per hectare)`)
  print(mk_test)
} else {
  message("The Kendall package is not installed. Install it with install.packages('Kendall') to run the Mann-Kendall trend test.")
}
```

## Summary

This chapter has demonstrated a variety of statistical tests using real agricultural and biodiversity datasets. We've covered:

1. **Tests for comparing groups**:
   - t-tests for comparing two groups
   - ANOVA for comparing multiple groups
   - Non-parametric alternatives when data doesn't meet parametric assumptions

2. **Tests for relationships**:
   - Correlation analysis to measure the strength of relationships
   - Regression analysis to model relationships between variables

3. **Tests for categorical data**:
   - Chi-Square test for examining associations between categorical variables

4. **Tests for time series data**:
   - Time series analysis for identifying patterns over time
   - Mann-Kendall test for detecting trends

When conducting statistical tests, remember to:
- Clearly define your research question
- Check if your data meets the assumptions of the test
- Choose the appropriate test based on your data type and research question
- Interpret results in the context of your research question
- Consider the practical significance, not just statistical significance

## Exercises

1. Using the crop yield dataset, compare maize yields between continents using both ANOVA and the Kruskal-Wallis test. Which is more appropriate and why?

2. Examine the relationship between potato and rice yields using correlation analysis. Calculate both Pearson and Spearman correlations and explain which is more appropriate.

3. Using the biodiversity dataset, investigate whether there's an association between conservation status and another categorical variable of your choice.

4. Perform a time series analysis of wheat yields for China and compare the trend with that of the United States.

5. Using the animal dataset (`../data/entomology/insects.csv`), compare two groups using an appropriate statistical test.

6. Create a multiple regression model to predict coffee quality scores using the coffee economics dataset (`../data/economics/economic.csv`).

## Enhanced Statistical Tests Chapter

The enhanced visualizations and tables for this chapter are available in a separate file to ensure compatibility with the book rendering process.
